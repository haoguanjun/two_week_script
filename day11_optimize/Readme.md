# Read me

> 由于在第 11 章需要修改 ASTree 基类，创建 day11 新的 branch。

在以前的环境 Environment 实现中，使用了 .NET 提供的字典 Dictionary 来实现键值映射。虽然字典是基于 Hash 值来实现的，但是，每次基于键值进行查找的时候，还是需要先计算 key 的哈希值，然后根据哈希值再找到对应的值。可以通过优化掉计算 Hash 的步骤来优化对变量的读写性能

11 章代码引用了第 17 章的解析器，而第 17 章的解析器又引用了第 3 章的 Token 和第 4 章的基本抽象语法树，涉及到 6 个基本类型的定义：

* ASTree
* ASTList
* ASTLeaf
* Name
* BinaryExpress
* NumberLiteral

由于现在并不涉及到 Token 的修改，涉及只会涉及到第 4 章中类型的修改。

我们希望为 ASTree 增加一个基本的预处理步骤，用来针对变量的使用做预先的处理，以便找出函数中变量的位置，以后使用位置而不是使用名称来访问变量。

为此起见，为第 4 章的 ASTree 增加一个 PreProcess() 的预处理方法。而此方法又涉及到 Symbols 的使用，所以，将此类的定义也加入到第 4 章的代码中。

## 1. 实现原理

在生成 AST 阶段，直接计算出变量在所对应的执行环境中所在的下标，保存到变量的定义中。在为变量赋值和取值的时候，直接使用在生成 AST 阶段预先计算出来的下标访问变量。

既然这样，可以考虑不再使用 Dictionary 来保存执行环境，而是直接使用数组 Array 来保存执行环境。

对于局部变量和全局变量可以分开考虑。

* 局部变量在函数定义之后，变量个数已经确定
* 全局变量变量个数是动态的，不能确定。

### 1.1 符号表 Symbols

由于变量在预处理过程中是逐步被处理的，一开始并不知道变量的个数，我们需要在处理过程中逐个记录变量，对于已经记录过的变量，只需要返回其位置即可。这里的处理使用一个符号表来管理。

在预处理完成之后，就可以直接使用变量下标，而不再需要使用符号表了。

### 1.2 函数局部变量

对于定义在函数内的局部变量而言，在函数定义之后，局部变量的数量和名称就已经确定。程序在执行过程中不能动态为函数添加局部变量或者改变变量的名称。
基于函数内的局部变量的特点，可以考虑使用简单的数组来处理局部变量。

* 首先考虑使用数组来保存局部变量
* 预先可以计算出变量名称所对应的数组下标位置，保存到变量中。
* 访问变量的时候，不再使用变量名称访问，而是使用预先计算好的下标来直接访问数组，得到变量的值。这样就优化掉了对变量名称计算 Hash 值的步骤。

将通过变量的名称访问优化为下标访问优化了对局部变量访问的性能。

为了实现该优化方式，需要在函数定义完成之后，遍历函数定义的抽象语法树 AST，获取函数所使用的所有局部变量定义和函数参数定义，这样就可以确定该函数所需要的局部变量的数量。然后从 0 开始对所有的局部变量计算出对应的下标。

除了局部变量对应的下标之外，还需要考虑作用域问题。

作用域使用嵌套的层数来表示，从当前作用域开始为 0 层，从最内层往外依此增加。

这样我们需要使用个数据结构来表示变量所处的位置。

```csharp
public class Location
{
    // 嵌套的层数，最内层为 0, 向外依此增加 1
    public int Nest { get; private set; }

    // 变量在作用域所处的下标
    public int Index { get; private set; }
    public Location(int nest, int index)
    {
        Nest = nest;
        Index = index;
    }
}
```

### 1.3 全局变量

对于全局变量继续使用原来的字典进行处理。

## 2. 实现优化后的执行环境



## 3. 代码改动

需要修改的语法节点：

* 函数定义 DefStamnt
* 闭包函数定义 ClosureFunction
* 函数参数定义 ParameterList
* 变量定义 Name
* 表达式的求值 BinaryExpress

### 3.1. 基类 ASTree 

增加 PreProcess() 预处理方法，该方法将在 Eval() 执行之前执行。完成需要的准备工作。

它的参数是符号表 Symbols 对象，该对象内部是一个 Hash 表，用来记录变量名和保存位置之间的关系。

涉及的语法节点需要自己实现对应的 PrePrecess() 预处理方法。

### 3.2. 函数定义 DefStmnt 中

#### 3.2.1 预处理

计算出本身在当前环境中的下标，以便之后访问使用

构建当前函数的符号表

#### 3.2.2 求值

就是将当前函数定义保存到以下标表示的执行环境中。

### 3.3. 闭包 ClosureFunction

#### 3.3.1 预处理



#### 3.3.2 求值

### 3.4. 参数列表 ParameterList

#### 3.4.1 预处理

需要根据分析得到的参数列表，计算出每个参数在数据中所处的位置下标。

#### 3.4.2 求值



### 3.5. 变量 Name

#### 3.5.1 预处理



#### 3.5.2 求值



### 3.6. 二值表达式 Binary

#### 3.6.1 预处理

针对赋值处理，

#### 3.6.2 求值

