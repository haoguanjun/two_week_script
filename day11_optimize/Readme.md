# Read me

在以前的环境 Environment 实现中，使用了 .NET 提供的字典 Dictionary 来实现键值映射。虽然字典是基于 Hash 值来实现的，但是，每次基于键值进行查找的时候，还是需要先计算 key 的哈希值，然后根据哈希值再找到对应的值。可以通过优化掉计算 Hash 的步骤来优化对变量的读写性能

## 实现原理
对于局部变量和全局变量可以分开考虑。
### 局部变量
对于定义在函数内的局部变量而言，在函数定义之后，局部变量的数量和名称就已经确定。程序在执行过程中不能动态为函数添加局部变量或者改变变量的名称。
基于函数内的局部变量的特点，可以考虑使用简单的数组来处理局部变量。

* 首先考虑使用数组来保存局部变量
* 预先可以计算出变量名称所对应的数组下标位置，保存到变量中。
* 访问变量的时候，不再使用变量名称访问，而是使用预先计算好的下标来直接访问数组，得到变量的值。这样就优化掉了对变量名称计算 Hash 值的步骤。

将通过变量的名称访问优化为下标访问优化了对局部变量访问的性能。

为了实现该优化方式，需要在函数定义完成之后，遍历函数定义的抽象语法树 AST，获取函数所使用的所有局部变量定义和函数参数定义，这样就可以确定该函数所需要的局部变量的数量。然后从 0 开始对所有的局部变量计算出对应的下标。

除了局部变量对应的下标之外，还需要考虑作用域问题。

作用域使用嵌套的层数来表示，从当前作用域开始为 0 层，从最内层往外依此增加。

这样我们需要使用个数据结构来表示变量所处的位置。

```csharp
public class Location
{
    // 嵌套的层数，最内层为 0, 向外依此增加 1
    public int Nest { get; private set; }

    // 变量在作用域所处的下标
    public int Index { get; private set; }
    public Location(int nest, int index)
    {
        Nest = nest;
        Index = index;
    }
}
```